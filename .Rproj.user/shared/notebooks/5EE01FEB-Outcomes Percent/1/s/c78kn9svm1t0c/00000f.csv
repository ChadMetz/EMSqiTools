"0",""
"0",""
"0","library(dplyr)"
"2","Warning: package ‘dplyr’ was built under R version 4.4.3"
"2","
Attaching package: ‘dplyr’

"
"2","The following objects are masked from ‘package:stats’:

    filter, lag

"
"2","The following objects are masked from ‘package:base’:

    intersect, setdiff, setequal, union

"
"0","library(ggplot2)"
"2","Warning: package ‘ggplot2’ was built under R version 4.4.3"
"0","library(lubridate)"
"2","Warning: package ‘lubridate’ was built under R version 4.4.3"
"2","
Attaching package: ‘lubridate’

"
"2","The following objects are masked from ‘package:base’:

    date, intersect, setdiff, union

"
"0","mean(df2$TimeDifferenceInMinutes)"
"1","[1]"
"1"," NA"
"1","
"
"0","# Aggregate by Year and Week"
"0","dataset_summary <- df2 %>%"
"0","  group_by(Year, Week_of_Year) %>%"
"0","  summarise("
"0","    Total_Incidents = n_distinct(`PCR Number`),"
"0","    Vitals_Taken_1 = sum(TimeToFinishCategory == ""Under 1 hour"", na.rm = TRUE)"
"0","  ) %>%"
"0","  mutate("
"0","    p = ifelse(Total_Incidents > 0, Vitals_Taken_1 / Total_Incidents, NA),"
"0","    Week_Date = as.Date(paste0(Year, ""-01-01"")) + weeks(Week_of_Year - 1)"
"0","  )"
"2","`summarise()` has grouped output by 'Year'. You can override using the `.groups` argument."
"0","# Calculate initial control limits (mean-based)"
"0","initial_CL <- mean(dataset_summary$p, na.rm = TRUE)"
"0","dataset_summary <- dataset_summary %>%"
"0","  mutate("
"0","    CL = initial_CL,"
"0","    UCL = pmin(CL + 2 * sqrt((CL * (1 - CL)) / Total_Incidents), 1),"
"0","    LCL = pmax(CL - 2 * sqrt((CL * (1 - CL)) / Total_Incidents), 0)"
"0","  )"
"0",""
"0","# Replace NA p with 0 for continuity"
"0","dataset_summary$p[is.na(dataset_summary$p)] <- 0"
"0",""
"0","# Detect shift: 8+ consecutive points above initial CL"
"0","run_length <- rle(dataset_summary$p > initial_CL)"
"0","shift_index <- which(run_length$values & run_length$lengths >= 8)"
"0",""
"0","if (length(shift_index) > 0) {"
"0","  shift_start <- sum(run_length$lengths[seq_len(shift_index[1] - 1)]) + 1"
"0","  "
"0","  # Recalculate CL, UCL, LCL after shift"
"0","  new_CL <- mean(dataset_summary$p[shift_start:nrow(dataset_summary)], na.rm = TRUE)"
"0","  "
"0","  pre_shift <- dataset_summary[1:(shift_start - 1), ] %>%"
"0","    mutate(CL_adj = CL,"
"0","           UCL_adj = UCL,"
"0","           LCL_adj = LCL)"
"0","  "
"0","  post_shift <- dataset_summary[shift_start:nrow(dataset_summary), ] %>%"
"0","    mutate(CL_adj = new_CL,"
"0","           UCL_adj = pmin(new_CL + 2 * sqrt((new_CL * (1 - new_CL)) / Total_Incidents), 1),"
"0","           LCL_adj = pmax(new_CL - 2 * sqrt((new_CL * (1 - new_CL)) / Total_Incidents), 0))"
"0","  "
"0","  dataset_summary <- bind_rows(pre_shift, post_shift)"
"0","  "
"0","  shift_date <- dataset_summary$Week_Date[shift_start]"
"0","  annotations <- data.frame("
"0","    Date = c(as.Date(""2024-09-01""), shift_date),"
"0","    Label = c(""ImageTrend Go Live"", ""Shift Detected""),"
"0","    Y_Pos = c(0.1, 0.15),"
"0","    X_Adjust = c(as.Date(""2024-09-05""), shift_date + 5),"
"0","    Color = c(""purple"", ""red"")"
"0","  )"
"0","} else {"
"0","  dataset_summary <- dataset_summary %>%"
"0","    mutate(CL_adj = CL, UCL_adj = UCL, LCL_adj = LCL)"
"0","  "
"0","  annotations <- data.frame("
"0","    Date = as.Date(c(""2024-09-01"")),"
"0","    Label = c(""ImageTrend Go Live""),"
"0","    Y_Pos = c(0.1),"
"0","    X_Adjust = as.Date(c(""2024-09-05"")),"
"0","    Color = c(""purple"")"
"0","  )"
"0","}"
"0",""
"0","# Step control limits"
"0","dataset_step <- dataset_summary %>%"
"0","  select(Week_Date, UCL_adj, LCL_adj) %>%"
"0","  mutate(Week_Date = Week_Date - 3)"
"2","Adding missing grouping variables: `Year`"
"0","dataset_step <- rbind(dataset_step, dataset_step[nrow(dataset_step), ])"
"0","dataset_step$Week_Date[nrow(dataset_step)] <- max(dataset_summary$Week_Date)"
"0",""
"0","# Prepare CL annotations for left and right sides"
"0","first_date <- min(dataset_summary$Week_Date)"
"0","last_date <- max(dataset_summary$Week_Date)"
"0",""
"0","cl_left_label <- dataset_summary %>%"
"0","  filter(Week_Date == first_date) %>%"
"0","  select(CL) %>%"
"0","  distinct() %>%"
"0","  mutate("
"0","    Week_Date = first_date - 40,  # moved even further left"
"0","    Label = paste0(""CL = "", scales::percent(CL, accuracy = 1)),"
"0","    CL_adj = CL"
"0","  )"
"2","Adding missing grouping variables: `Year`"
"0","cl_right_label <- dataset_summary %>%"
"0","  filter(Week_Date == last_date) %>%"
"0","  select(CL_adj) %>%"
"0","  distinct() %>%"
"0","  mutate("
"0","    Week_Date = last_date + 5,  # right side"
"0","    Label = paste0(""CL = "", scales::percent(CL_adj, accuracy = 1))"
"0","  )"
"2","Adding missing grouping variables: `Year`"
"0","cl_labels <- bind_rows(cl_left_label, cl_right_label)"
"0",""
"0","# Plot"
"0","p <- ggplot(dataset_summary, aes(x = Week_Date, y = p)) +"
"0","  geom_line(linewidth = 1, color = ""black"") +"
"0","  geom_point(size = 2, color = ""black"") +"
"0","  "
"0","  geom_step(data = dataset_step, aes(x = Week_Date, y = UCL_adj), linetype = ""dotted"", color = ""red"", linewidth = 1) +"
"0","  geom_step(data = dataset_step, aes(x = Week_Date, y = LCL_adj), linetype = ""dotted"", color = ""red"", linewidth = 1) +"
"0","  "
"0","  geom_line(aes(y = CL_adj), color = ""blue"", linewidth = 1) +"
"0","  "
"0","  geom_segment(data = annotations,"
"0","               aes(x = Date, xend = Date, y = 0, yend = 0.7, color = Color),"
"0","               linetype = ""dashed"", linewidth = 1) +"
"0","  "
"0","  geom_text(data = annotations,"
"0","            aes(x = X_Adjust, y = pmax(0.05, Y_Pos), label = Label, color = Color),"
"0","            angle = 0, vjust = -1, hjust = 0, size = 4, show.legend = FALSE) +"
"0","  "
"0","  geom_text(data = cl_labels,"
"0","            aes(x = Week_Date, y = CL_adj, label = Label),"
"0","            color = ""blue"", hjust = c(-0.2, 0), vjust = 0.5, size = 4) +  # left label right-aligned, right label left-aligned"
"0","  "
"0","  scale_color_identity() +"
"0","  "
"0","  labs("
"0","    title = ""Proportion of patient care reports marked as finished within one hour of returning to service"","
"0","    x = ""Week"","
"0","    y = ""Proportion"""
"0","  ) +"
"0","  scale_x_date(date_labels = ""%b %Y"", date_breaks = ""1 month"", expand = expansion(mult = c(0.0001, 0.1))) +"
"0","  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0, 1)) +"
"0","  theme_minimal() +"
"0","  theme("
"0","    plot.title = element_text(size = 16, face = ""bold"", hjust = 0.5),"
"0","    axis.text.x = element_text(angle = 45, hjust = 1, size = 12),"
"0","    axis.text.y = element_text(size = 12),"
"0","    axis.title.x = element_text(size = 12, face = ""bold""),"
"0","    axis.title.y = element_text(size = 12, face = ""bold"")"
"0","  )"
"0",""
"0","# Display plot"
"0","print(p)"
